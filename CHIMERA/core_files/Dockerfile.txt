# --- CUSTOMIZATION POINT: Choose base image for build stage ---
# Replace with specific CUDA or OCaml version (e.g., nvidia/cuda:12.2.0-devel-ubuntu22.04)
FROM nvidia/cuda:12.0.0-devel-ubuntu22.04 AS builder

WORKDIR /app
# --- CUSTOMIZATION POINT: Install build dependencies ---
# Add packages for your specific build environment
RUN apt-get update && apt-get install -y python3.10 python3-pip build-essential ocaml opam && rm -rf /var/lib/apt/lists/*

# --- CUSTOMIZATION POINT: Copy and install project files ---
COPY . .
RUN pip install -r requirements.txt && opam init --disable-sandboxing && opam install dune

# --- CUSTOMIZATION POINT: Choose runtime base image ---
# Replace with lightweight image for production (e.g., nvidia/cuda:12.0.0-runtime-ubuntu22.04)
FROM nvidia/cuda:12.0.0-runtime-ubuntu22.04 AS runtime

WORKDIR /app
# --- CUSTOMIZATION POINT: Copy only necessary files from builder stage ---
COPY --from=builder /app /app
# --- CUSTOMIZATION POINT: Expose additional ports ---
EXPOSE 8000 9090 8080

# --- CUSTOMIZATION POINT: Set environment variables ---
# Update variables for your deployment (e.g., database URI, CUDA settings)
ENV NVIDIA_DRIVER_CAPABILITIES=compute,utility,video
ENV CUDA_VISIBLE_DEVICES=0,1,2,3
ENV SQLALCHEMY_DATABASE_URI=postgresql://user:pass@localhost:5432/chimera_hub

# --- CUSTOMIZATION POINT: Define entrypoint or command ---
# Customize startup command or add scripts
CMD ["python3", "chimera_2048_api_gateway.py"]
